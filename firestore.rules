rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función para verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Función para verificar si el usuario es el propietario del documento
    function isOwner(userId) {
      return request.auth.token.email == userId;
    }
    
    // Función para verificar si el usuario es tutor
    function isTutor() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/user/$(request.auth.token.email)) &&
             get(/databases/$(database)/documents/user/$(request.auth.token.email)).data.isTutor == true;
    }

    // Usuarios pueden leer y escribir su propia información
    match /user/{userId} {
      allow read, write: if request.auth != null && request.auth.token.email == userId;
      allow read: if request.auth != null; // Lectura para buscar tutores
    }
    
    // Materias son de solo lectura para usuarios autenticados
    match /course/{courseId} {
      allow read: if request.auth != null;
      allow write: if false; // Solo administradores pueden modificar
    }
    
    // Carreras son de solo lectura
    match /major/{majorId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    // Disponibilidades
    match /availabilities/{availId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (request.auth.token.email == resource.data.tutorEmail ||
         request.auth.token.email == resource.data.tutorId);
      allow create: if request.auth != null;
      allow update: if request.auth != null &&
        (request.auth.token.email == resource.data.tutorEmail ||
         request.auth.token.email == resource.data.tutorId ||
         // Permitir que estudiantes marquen como reservado
         (request.resource.data.isBooked == true && request.resource.data.bookedBy == request.auth.token.email));
    }
    
    // Sesiones de tutoría
    match /tutoring_sessions/{sessionId} {
      allow read: if request.auth != null && 
        (request.auth.token.email == resource.data.tutorEmail || 
         request.auth.token.email == resource.data.studentEmail);
      allow create: if request.auth != null &&
        request.auth.token.email == request.resource.data.studentEmail;
      allow update: if request.auth != null && 
        (request.auth.token.email == resource.data.tutorEmail || 
         request.auth.token.email == resource.data.studentEmail);
      allow delete: if false; // No permitir eliminación, solo cancelación via update
    }
    
    // Pagos - solo lectura para usuarios involucrados
    match /payments/{paymentId} {
      allow read: if request.auth != null && 
        (request.auth.token.email == resource.data.tutorEmail || 
         request.auth.token.email == resource.data.studentEmail);
      allow write: if false; // Los pagos se manejan por la aplicación
    }
    
    // REGLAS ESPECIALES: Para desarrollo y testing
    // Puedes habilitar estas reglas temporalmente para testing
    // ⚠️ REMOVER EN PRODUCCIÓN ⚠️
    /*
    match /{document=**} {
      allow read, write: if true; // ⚠️ SOLO PARA DESARROLLO - REMOVER EN PRODUCCIÓN
    }
    */
  }
} 